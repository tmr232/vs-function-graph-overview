name: Release

on:
  release:
    types: [prereleased, released]

permissions: {}

jobs:
  build-webview:
    name: Build Webview
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
        with:
          repository: tmr232/function-graph-overview
          ref: "visualstudio-1.0.1"
          persist-credentials: false

      - uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # ratchet:oven-sh/setup-bun@v2

      - run: bun install
      - run: bun build-webview

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: webview
          path: "./dist/webview/"

  release:
    name: Build & Publish
    runs-on: windows-latest
    needs: [build-webview]
    permissions:
      contents: write
    steps:
      - name: Fetch Sources
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
          persist-credentials: false

      - name: Fetch Webview
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # ratchet:actions/download-artifact@v4
        with:
          name: webview
          path: FunctionGraphOverview/WebviewAssets

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@6fb02220983dee41ce7ae257b6f4d8f9bf5ed4ce # ratchet:microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@323ab0502cd38fdc493335025a96c8fdb0edc71f # ratchet:nuget/setup-nuget@v2

      - name: Stamp versions from release tag
        shell: pwsh
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          $tag = $env:RELEASE_TAG.Trim()

          if ($tag -match '(\d+\.\d+\.\d+(?:\.\d+)?)') {
            $vsixVersion = $Matches[1]
          } else {
            throw "Release tag '$tag' does not contain a valid version like 1.2.3 or 1.2.3.4"
          }

          $parts = $vsixVersion.Split('.')
          if ($parts.Count -eq 3) {
            $asmVersion = "$vsixVersion.0"
          } elseif ($parts.Count -eq 4) {
            $asmVersion = $vsixVersion
          } else {
            throw "Parsed version '$vsixVersion' is not 3- or 4-part."
          }

          Write-Host "Stamping VSIX version: $vsixVersion"
          Write-Host "Stamping assembly version: $asmVersion"

          $assemblyInfoPath = "FunctionGraphOverview\Properties\AssemblyInfo.cs"
          $assemblyInfo = Get-Content $assemblyInfoPath -Raw
          $assemblyInfo = $assemblyInfo -replace 'AssemblyVersion\(".*?"\)', "AssemblyVersion(`"$asmVersion`")"
          $assemblyInfo = $assemblyInfo -replace 'AssemblyFileVersion\(".*?"\)', "AssemblyFileVersion(`"$asmVersion`")"
          Set-Content -Path $assemblyInfoPath -Value $assemblyInfo -Encoding UTF8

          $manifestPath = "FunctionGraphOverview\source.extension.vsixmanifest"
          [xml]$xml = Get-Content $manifestPath
          $ns = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)
          $ns.AddNamespace("x", "http://schemas.microsoft.com/developer/vsx-schema/2011")
          $identity = $xml.SelectSingleNode("//x:Identity", $ns)
          if (-not $identity) { throw "Could not find <Identity> node in $manifestPath" }
          $identity.SetAttribute("Version", $vsixVersion)
          $xml.Save($manifestPath)

      - name: Restore NuGet Packages
        run: nuget restore vs-function-graph-overview.sln

      - name: Build Solution
        run: msbuild vs-function-graph-overview.sln /p:Configuration=Release /p:Platform="Any CPU"

      - name: Publish to VS Marketplace
        run: |
          & "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VSSDK\VisualStudioIntegration\Tools\Bin\VsixPublisher.exe" `
            publish `
            -payload "FunctionGraphOverview\bin\Release\FunctionGraphOverview.vsix" `
            -publishManifest "publish-manifest.json" `
            -personalAccessToken "${{ secrets.VS_MARKETPLACE_PAT }}"

      - name: Upload Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: gh release upload "$env:RELEASE_TAG" FunctionGraphOverview/bin/Release/FunctionGraphOverview.vsix
